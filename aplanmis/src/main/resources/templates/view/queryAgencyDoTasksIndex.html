<!DOCTYPE html>
<html lang="en">
<!--公共引入的js css-->
<head th:fragment="commonheader(title)">
  <meta charset="UTF-8">
  <title>项目代办</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <link rel="stylesheet" href="/framework-ui/src/main/resources/static/agcloud/framework/js-lib/element-2/element.css"
        th:href="@{/agcloud/framework/js-lib/element-2/element.css}"/>
  <link rel="stylesheet"
        href="/framework-ui/src/main/resources/static/agcloud/framework/icon-lib/agcloud-fonts/iconfont.css"
        th:href="@{/agcloud/framework/icon-lib/agcloud-fonts/iconfont.css}">
  <link rel="stylesheet"
        href="/framework-ui/src/main/resources/static/agcloud/framework/js-lib/agcloud-lib/css/reset.css"
        th:href="@{/agcloud/framework/js-lib/agcloud-lib/css/reset.css}">
  <link rel="stylesheet" href="../../static/searchTable/css/search-table.css"
        th:href="@{/searchTable/css/search-table.css}">
  
  <script>
    var ctx = '[[@{/}]]';
    //  var ctx = "http://192.168.30.22:8083/aplanmis-front/";
    var viewDataCtrl = '[[${viewDataCtrl}]]';
  </script>
  <script src="../../static/approve/js/ip.js" th:src="@{/approve/js/ip.js}"></script>
  <style type="text/css">
    .remind_btn {
      color: white;
      cursor: pointer;
      background-color: #FF9933;
      height: 22px;
      width: 70px;
      line-height: 22px;
      margin: 0px;
      margin-left: 10px;
      border-radius: 20px;
      border: #FF9933;
      font-size: 12px;
    }
    
    .remind_text {
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }
    
    .sendMsg {
      padding: 10px 20px;
      border-bottom: 1px solid #EBEDF2;
    }
    
    .remindContent {
      text-indent: 20px;
      padding: 10px 20px;
      min-height: 200px;
      font-size: 16px;
    }
    
    .more-time {
      display: inline-block;
      background: #DDDFE3;
      position: relative;
      width: 30px;
      height: 24px;
      line-height: 24px;
      text-align: center;
      border-radius: 12px;
      color: #fff;
    }
    .solicit-opinion-dialog .el-dialog__body,
    .solicit-opinion-dialog .el-dialog__footer {
      background: #F0F3F6;
    }

    .solicit-opinion-dialog .el-dialog__footer {
      padding: 12px 25px;
    }

    .solicit-opinion-dialog .el-dialog__body {
      padding: 14px 14px 0 14px;
    }
    .solicit-opinion-dialog .el-dialog__footer{
      padding: 10px 16px 14px 16px;
    }
    .stop-agent .el-dialog__body .el-form{
      padding-right:0;
    }
    .stop-a-box{
      background: #fff;
      padding: 20px 20px 6px 20px;
      overflow: auto;
    }
    .au-hint-text {
      position: relative;
      line-height: 20px;
      padding: 12px;
      padding-left: 40px;
      border: 1px solid #FFB822;
      background: #FFFCEE;
      border-radius: 4px;
      margin-bottom: 12px;
    }

    .au-hint-text .ag-warn-circle {
      position: absolute;
      top: 12px;
      left: 14px;
      color: #FFB822;
      font-size: 20px;
    }
    .agent-agreement .el-dialog__body{
      padding: 0;
    }
    .agent-agreement iframe{
      border: none;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body class="gray-body">
<div class="search-table" id="searchTable" v-loading.fullscreen.lock="loading" v-cloak
     :style="{minHeight: (curHeight-32)+'px'}">
  <div class="search-box">
    <el-form class="search-from clearfix" label-width="100px">
      <el-col :span="24" class="search-item-fif">
        <el-form-item label="搜索关键字" class="search-input">
          <el-input v-model="searchFrom.keyword" placeholder="请输入项目/工程编码、名称等关键词">
            <el-button slot="append" icon="el-icon-search" @click="tableDataSearch">查询</el-button>
          </el-input>
        </el-form-item>
        <span class="more-search-item" @click="showMoreSearchItem=!showMoreSearchItem">高级查询 <i class="icon ag"
                                                                                               :class="showMoreSearchItem?'ag-up-arrow':'ag-down-arrow'"></i></span>
      </el-col>
      <template v-if="showMoreSearchItem">
        <el-col :span="8">
          <el-form-item label="代办状态">
            <el-select v-model="searchFrom.agentApplyState" placeholder="请选择" clearable @change="tableDataSearch">
              <el-option
                  v-for="(value, key) in agentApplyStateMap"
                  :key="key"
                  :label="value"
                  :value="key">
              </el-option>
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="项目类型">
            <el-select v-model="searchFrom.theme" placeholder="请选择" clearable  @change="tableDataSearch">
              <el-option
                  v-for="item in themeList"
                  :key="item.themeId"
                  :label="item.themeName"
                  :value="item.themeId">
              </el-option>
            </el-select>
          </el-form-item>
        </el-col>
        <el-col :span="8">
          <el-form-item label="申请时间">
            <el-col :span="10">
              <el-form-item prop="searchFrom.minStartTime">
                <el-date-picker type="date"
                                format="yyyy-MM-dd"
                                value-format="yyyy-MM-dd"
                                placeholder="选择时间"
                                v-model="searchFrom.minStartTime"
                                style="width: 100%;"
                                @change="tableDataSearch">
                </el-date-picker>
              </el-form-item>
            </el-col>
            <span class="line fl" style="padding: 0 5px">-</span>
            <el-col :span="10">
              <el-form-item prop="searchFrom.maxStartTime">
                <el-date-picker type="date"
                                format="yyyy-MM-dd"
                                value-format="yyyy-MM-dd"
                                placeholder="选择时间"
                                v-model="searchFrom.maxStartTime"
                                style="width: 100%;"
                                @change="tableDataSearch">
                </el-date-picker>
              </el-form-item>
            </el-col>
          </el-form-item>
        </el-col>
      </template>
    </el-form>
  </div>
  
  <el-table class="search-content"
            :data="tableData"
            border stripe
            style="width: 100%"
            :default-sort="{prop: 'startTime', order: 'descending'}"
            @sort-change='sortChange'>
    <el-table-column
            prop="agentCode"
            min-width="140"
            label="代办申请编号"
            show-overflow-tooltip
            :formatter="formatTableCell">
    </el-table-column>
    <el-table-column
        prop="localCode"
        min-width="200"
        label="项目代码"
        show-overflow-tooltip
        :formatter="formatTableCell">
    </el-table-column>
    <el-table-column
        prop="projName"
        min-width="150"
        label="项目/工程名称">
      <template scope="scope">
        <el-tooltip effect="light" placement="top">
          <div slot="content" v-html="showProjInfo(scope.row)"></div>
          <span>{{scope.row.projName?scope.row.projName:'-'}}</span>
        </el-tooltip>
      </template>
    </el-table-column>
    <!--主题-->
    <el-table-column
        prop="themeName"
        min-width="200"
        label="项目类型"
        show-overflow-tooltip
        :formatter="formatTableCell">
    </el-table-column>
    <el-table-column
        min-width="240px"
        prop="agentStageState"
        label="代办阶段">
      <template scope="scope">
        <el-tooltip effect="light" placement="top">
          <div slot="content" v-html="showStageInfo(scope.row)"></div>
          <span v-html="agentStageStateFormatter(scope.row)"></span>
        </el-tooltip>
      </template>
    </el-table-column>
    <el-table-column
        prop="agentApplyState"
        min-width="100"
        label="代办状态"
        show-overflow-tooltip
        :formatter="formatAgentApplyState">
    </el-table-column>
    <el-table-column
        sortable="custom"
        min-width="140"
        prop="startTime"
        label="申请时间"
        show-overflow-tooltip
        :formatter="formatTableCell">
    </el-table-column>
    <el-table-column
        min-width="160"
        label="操作">
      <template slot-scope="scope">
        <span class="op-btn" v-if="showOperateBtn1(scope.row)" @click="toAgencyDetail(scope.row, 'do')">签订协议</span>
        <span class="op-btn" v-if="showOperateBtn2(scope.row)" @click="toAgencyDetail(scope.row, 'view')">查看</span>
        <span class="op-btn" v-if="showOperateBtn3(scope.row)" @click="toApplyPage(scope.row)">办理</span>
        <span class="op-btn" v-if="showOperateBtn3(scope.row)" @click="banjie(scope.row)">办结</span>
        <span class="op-btn" v-if="showOperateBtn3(scope.row)" @click="clickStopAgent(scope.row)">终止协议</span>
      </template>
    </el-table-column>
  </el-table>
  
  <el-pagination class="mt20 mb20 mr20 el-pagination-top" background align="right" @size-change="handleSizeChange"
                 @current-change="handleCurrentChange" :page-sizes="[10, 20, 30, 50]"
                 :page-size="searchFrom.pagination.perpage"
                 :current-page="searchFrom.pagination.page" layout="total,sizes, prev, pager, next, jumper"
                 :total="dataTotal" v-show="dataTotal>10">
  </el-pagination>

  <!-- 代办委托办结dialog -->
  <el-dialog title="代办委托办结" class="solicit-opinion-dialog end-agent" :visible.sync="isShowBanjieDialog"
    width="800px" top="100px">
    <div class="stop-a-box">
      <p class="au-hint-text">
        <i class="ag ag-warn-circle"></i>
        请确认办结日期后点击“签章”
      </p>
      <el-form :model="endAgentForm" :rules="endrules" label-width="100px" size="medium">
        <el-form-item label="代办委托项目">
          <el-input readonly v-model="curBanjieRow.projName"></el-input>
        </el-form-item>
        <el-form-item label="协议编号">
          <el-input readonly  v-model="curBanjieRow.agreementCode"></el-input>
        </el-form-item>
        <el-form-item label="办结日期" prop="agreementEndTime">
          <el-date-picker v-model="endAgentForm.agreementEndTime"
           format="yyyy-MM-dd" value-format="yyyy-MM-dd"
           :clearable="false" type="date" placeholder="选择日期">
          </el-date-picker>
        </el-form-item>
        <el-form-item label="委托办结单">
          <el-input :value="curBanjieRow.projName + '代办委托办结单.pdf'">
            <el-button type="primary" slot="append" @click="viewBanjiePdf">查看</el-button>
          </el-input>
        </el-form-item>  
      </el-form>
    </div>
    <div slot="footer" class="dialog-footer">
      <el-button @click="isShowBanjieDialog = false">关闭</el-button>
      <el-button type="primary" >签章</el-button>
    </div>
  </el-dialog>

  <!-- 办结单弹框 -->
  <el-dialog title="办结单"  :visible.sync="prePdfVisible" ref="prePdfRef" class="solicit-opinion-dialog end-agent" width="800px" top="10vh">
    <div class="stop-a-box" style="height: 580px;">
      <iframe :src="pdfSrc" class='ltab-iframe' style="width: 100%; height: 100%;"></iframe>
    </div>
    <span slot="footer" class="dialog-footer">
      <el-button @click="prePdfVisible = false;">取 消</el-button>
    </span>
  </el-dialog>
  <!-- 项目代办终止协议 start -->
  <el-dialog title="待办委托终止单" class="solicit-opinion-dialog stop-agent" v-loading="stopAgentDialogLoading"
             :close-on-click-modal="false" :visible.sync="stopAgentDialogVisible" @close="closeStopAgentDialog"
             :width="curWidth>820?'800px':(curWidth-20)+'px'" top="100px">
    <div :style="{'max-height': (curHeight-305)+'px'}" class="stop-a-box">
      <p class="au-hint-text">
        <i class="ag ag-warn-circle"></i>
        请填写终止原因，确认终止日期后点击“签章”
      </p>
      <el-form :model="stopAgentForm" label-width="112px" size="medium">
        <el-form-item label="代办委托项目">
          <el-input v-model="targetRow.projName" readonly></el-input>
        </el-form-item>
        <el-form-item label="协议编号">
          <el-input v-model="stopAgentForm.code" readonly></el-input>
        </el-form-item>
        <el-form-item label="终止日期">
          <el-date-picker v-model="stopAgentForm.date" :clearable="false"
                          type="date" placeholder="选择日期">
          </el-date-picker>
        </el-form-item>
        <el-form-item label="终止原因">
          <el-input v-model="stopAgentForm.reason" type="textarea" :rows="3"></el-input>
        </el-form-item>
        <el-form-item label="待办委托终止单">
          <el-input v-model="stopAgentForm.fileName">
            <!--<el-button type="primary" slot="append" @click="seeStopAgent">查看</el-button>-->
          </el-input>
        </el-form-item>
      </el-form>
    </div>
    <div slot="footer" class="dialog-footer">
      <el-button @click="stopAgentDialogVisible = false">关闭</el-button>
      <el-button type="primary" @click="seeStopAgent">查看终止单</el-button>
      <el-button type="primary" @click="ensureStopAgent">签章</el-button>
    </div>
  </el-dialog>
  <!-- 项目代办终止协议 end -->
  <!-- 项目代办协议 查看pdf弹窗 start -->
  <el-dialog title="查看协议" class="solicit-opinion-dialog agent-agreement" v-loading="prePdfDialogLoading"
             :close-on-click-modal="false" :visible.sync="prePdfDialogVisible" @close="closePrePdf"
             :width="curWidth>1220?'1200px':(curWidth-20)+'px'" top="20px">
    <div :style="{height: (curHeight-175)+'px'}">
      <iframe :src="prePdfUrl"></iframe>
    </div>
    <div slot="footer" class="dialog-footer">
      <el-button @click="prePdfDialogVisible = false">关闭</el-button>
      <el-button type="primary" @click="downLoadAgreement">下载</el-button>
    </div>
  </el-dialog>
  <!-- 项目代办协议 查看pdf弹窗 end -->
</div>

<script src="/framework-ui/src/main/resources/static/agcloud/framework/js-lib/jquery-v1/jquery.min.js"
        th:src="@{/agcloud/framework/js-lib/jquery-v1/jquery.min.js}"></script>
<script src="/framework-ui/src/main/resources/static/agcloud/framework/js-lib/vue-v2/vue.js"
        th:src="@{/agcloud/framework/js-lib/vue-v2/vue.js}"></script>
<script src="/framework-ui/src/main/resources/static/agcloud/framework/js-lib/element-2/element.js"
        th:src="@{/agcloud/framework/js-lib/element-2/element.js}"></script>
<script src="../../static/preview/pdfjs/build/pdf.js" th:src="@{/preview/pdfjs/build/pdf.js}"></script>
<script src="/framework-ui/src/main/resources/static/agcloud/framework/js-lib/agcloud-lib/js/common.js"
        th:src="@{/agcloud/framework/js-lib/agcloud-lib/js/common.js}"></script>

<script src="../../static/view/js/mixins.js" th:src="@{/view/js/mixins.js}"
        type="text/javascript"></script>
<script src="../../static/view/js/queryAgencyDoTasksIndex.js" th:src="@{/view/js/queryAgencyDoTasksIndex.js}"
        type="text/javascript"></script>
</body>

</html>